<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>SASO | Student Records Dashboard</title>
<link rel="icon" type="image/jpg" href="school logo.jpg"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
:root {
    --primary-50: #f0fdf4;
    --primary-100: #dcfce7;
    --primary-200: #bbf7d0;
    --primary-300: #86efac;
    --primary-400: #4ade80;
    --primary-500: #22c55e;
    --primary-600: #16a34a;
    --primary-700: #15803d;
    --primary-800: #166534;
    --primary-900: #14532d;
    --primary-950: #052e16;
    --bg-body: #f8fff9;
    --sidebar-bg: linear-gradient(180deg, var(--primary-900) 0%, var(--primary-800) 100%);
    --card-bg: #ffffff;
    --text-main: #0f172a;
    --text-muted: #475569;
    --text-light: #94a3b8;
    --radius-lg: 20px;
    --radius-md: 12px;
    --radius-sm: 8px;
    --shadow-sm: 0 1px 3px rgba(6, 95, 70, 0.12);
    --shadow-md: 0 4px 6px rgba(6, 95, 70, 0.1);
    --shadow-lg: 0 10px 25px rgba(6, 95, 70, 0.15);
    --shadow-xl: 0 20px 40px rgba(6, 95, 70, 0.2);
    --transition: all 0.3s ease;
}
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: 'Plus Jakarta Sans', sans-serif;
    -webkit-tap-highlight-color: transparent;
}
body {
    background-color: var(--bg-body);
    color: var(--text-main);
    min-height: 100vh;
    padding-bottom: 80px;
    background-image:
        radial-gradient(circle at 10% 20%, rgba(187, 247, 208, 0.15) 0%, transparent 25%),
        radial-gradient(circle at 90% 80%, rgba(187, 247, 208, 0.1) 0%, transparent 25%);
}
/* Sidebar Design */
.sidebar {
    width: 280px;
    background: var(--sidebar-bg);
    color: white;
    display: flex;
    flex-direction: column;
    padding: 35px 25px;
    position: fixed;
    height: 100vh;
    transition: var(--transition);
    z-index: 1000;
    box-shadow: var(--shadow-xl);
    border-top-right-radius: 25px;
    border-bottom-right-radius: 25px;
    overflow: hidden;
}
.sidebar::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(90deg, var(--primary-400), var(--primary-600));
}
.sidebar h2 {
    font-size: 24px;
    font-weight: 800;
    margin-bottom: 40px;
    color: white;
    text-align: center;
    padding: 20px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-md);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    position: relative;
    overflow: hidden;
}
.sidebar h2 i {
    color: var(--primary-300);
    margin-right: 10px;
}
.nav-link {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 16px 20px;
    color: var(--primary-200);
    text-decoration: none;
    border-radius: var(--radius-md);
    margin-bottom: 10px;
    transition: var(--transition);
    font-weight: 500;
    position: relative;
    border: 1px solid transparent;
}
.nav-link:hover {
    background: rgba(255, 255, 255, 0.15);
    color: white;
    transform: translateX(5px);
    border-color: rgba(255, 255, 255, 0.3);
}
.nav-link.active {
    background: linear-gradient(90deg, rgba(34, 197, 94, 0.3), rgba(34, 197, 94, 0.1));
    color: white;
    font-weight: 600;
    box-shadow: var(--shadow-sm);
    border-left: 4px solid var(--primary-400);
    border-color: rgba(255, 255, 255, 0.3);
}
.nav-link i {
    font-size: 20px;
    width: 24px;
    text-align: center;
}
.nav-link.logout {
    margin-top: auto;
    color: #fecaca;
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.2);
}
.nav-link.logout:hover {
    background: rgba(239, 68, 68, 0.2);
    color: #fca5a5;
}
/* Main Content Area */
.main-content {
    margin-left: 280px;
    padding: 30px;
    transition: var(--transition);
}
/* Dashboard Header */
.dash-header {
    margin-bottom: 30px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 20px;
}
.dash-header h1 {
    font-size: 32px;
    font-weight: 800;
    position: relative;
    display: inline-block;
    color: var(--primary-800);
    background: linear-gradient(135deg, var(--primary-600), var(--primary-800));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
/* Stats Card */
.stats-container {
    display: flex;
    justify-content: center;
    margin-bottom: 30px;
}
.stat-card {
    background: linear-gradient(135deg, var(--primary-50), var(--primary-100));
    border-radius: var(--radius-lg);
    padding: 35px 40px;
    box-shadow: var(--shadow-xl);
    transition: var(--transition);
    border: 1px solid var(--primary-200);
    position: relative;
    overflow: hidden;
    width: 100%;
    max-width: 800px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background: linear-gradient(90deg, var(--primary-400), var(--primary-600));
}
.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 25px 50px rgba(6, 95, 70, 0.25);
}
.stat-card .stat-content {
    display: flex;
    align-items: center;
    gap: 30px;
    width: 100%;
}
.stat-card .stat-icon {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    color: white;
    background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
    box-shadow: 0 10px 25px rgba(34, 197, 94, 0.4);
    flex-shrink: 0;
}
.stat-card .stat-info {
    flex: 1;
}
.stat-card .stat-number {
    font-size: 72px;
    font-weight: 900;
    background: linear-gradient(135deg, var(--primary-600), var(--primary-800));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1;
    margin-bottom: 10px;
    text-shadow: 0 2px 10px rgba(34, 197, 94, 0.2);
}
.stat-card .stat-label {
    font-size: 20px;
    color: var(--text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 15px;
}
.stat-card .stat-description {
    font-size: 16px;
    color: var(--text-light);
    max-width: 400px;
    line-height: 1.5;
}
/* Filter Bar */
.filter-bar {
    background: var(--card-bg);
    padding: 25px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    margin-bottom: 30px;
    border: 1px solid var(--primary-100);
    position: relative;
    overflow: hidden;
}
.filter-bar::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-400), var(--primary-600));
}
.filter-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}
.filter-header i {
    color: var(--primary-600);
    font-size: 20px;
}
.filter-header h3 {
    font-size: 18px;
    color: var(--primary-800);
    font-weight: 700;
}
.filter-controls {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    align-items: center;
}
.filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-width: 200px;
    flex: 1;
}
.filter-group label {
    font-size: 14px;
    color: var(--text-muted);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}
.filter-group label i {
    color: var(--primary-500);
}
.filter-select {
    padding: 14px 18px;
    border: 2px solid var(--primary-200);
    border-radius: var(--radius-md);
    background: var(--primary-50);
    font-size: 15px;
    color: var(--text-main);
    outline: none;
    transition: var(--transition);
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2316a34a' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 18px center;
    background-size: 16px;
    padding-right: 45px;
}
.filter-select:focus {
    border-color: var(--primary-500);
    background: white;
    box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
}
.filter-select:hover {
    border-color: var(--primary-300);
}
.filter-actions {
    display: flex;
    gap: 15px;
    margin-top: 25px;
    align-items: center;
}
.filter-btn {
    padding: 14px 28px;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 15px;
}
.filter-btn.apply {
    background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
    color: white;
    box-shadow: 0 4px 0 var(--primary-800), 0 6px 15px rgba(0,0,0,0.1);
}
.filter-btn.apply:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 0 var(--primary-800), 0 10px 20px rgba(0,0,0,0.15);
}
.filter-btn:active {
    transform: translateY(2px);
}
.filter-status {
    margin-left: auto;
    font-size: 14px;
    color: var(--text-muted);
    padding: 10px 18px;
    background: var(--primary-50);
    border-radius: var(--radius-md);
    border: 1px solid var(--primary-200);
}
.filter-status span {
    font-weight: 700;
    color: var(--primary-700);
}
/* Top Bar */
.top-bar {
    background: var(--card-bg);
    padding: 25px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    border: 1px solid var(--primary-100);
    position: relative;
    overflow: hidden;
}
.search-box {
    padding: 16px 22px;
    border: 2px solid var(--primary-200);
    border-radius: var(--radius-md);
    flex: 1;
    background: var(--primary-50);
    font-size: 16px;
    outline: none;
    transition: var(--transition);
    box-shadow: var(--shadow-sm);
    color: var(--text-main);
}
.search-box:focus {
    border-color: var(--primary-500);
    background: white;
    box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
}
.add-btn {
    background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
    color: white;
    padding: 16px 30px;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 700;
    cursor: pointer;
    white-space: nowrap;
    transition: var(--transition);
    box-shadow: 0 6px 0 var(--primary-800), 0 10px 20px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 16px;
}
.add-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 0 var(--primary-800), 0 15px 25px rgba(0,0,0,0.15);
}
.add-btn:active {
    transform: translateY(4px);
    box-shadow: 0 2px 0 var(--primary-800), 0 5px 10px rgba(0,0,0,0.1);
}
/* Table Design */
.table-wrapper {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    border: 1px solid var(--primary-100);
    position: relative;
}
.table-wrapper::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background: linear-gradient(90deg, var(--primary-400), var(--primary-600));
}
table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}
thead {
    background: linear-gradient(90deg, var(--primary-50), var(--primary-100));
}
th {
    padding: 20px 25px;
    text-align: left;
    font-size: 13px;
    color: var(--primary-800);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 700;
    border-bottom: 2px solid var(--primary-300);
}
td {
    padding: 20px 25px;
    font-size: 15px;
    border-bottom: 1px solid var(--primary-100);
    vertical-align: middle;
}
tbody tr {
    transition: var(--transition);
}
tbody tr:hover {
    background-color: var(--primary-50);
    transform: translateX(5px);
}
/* Date Column */
.date-cell {
    font-size: 13px;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 8px;
}
.date-cell i {
    color: var(--primary-500);
}
/* Status Toast */
#status {
    position: fixed;
    top: 25px;
    right: 25px;
    background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
    color: white;
    padding: 18px 28px;
    border-radius: var(--radius-md);
    display: none;
    z-index: 2000;
    box-shadow: var(--shadow-xl);
    font-weight: 600;
    border-left: 5px solid white;
    animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    max-width: 400px;
}
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
/* Action Buttons */
.action-group {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}
.action-btn {
    width: 42px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    border: none;
    cursor: pointer;
    transition: var(--transition);
    font-size: 17px;
    box-shadow: var(--shadow-sm);
}
.action-btn:hover {
    transform: translateY(-3px) scale(1.1);
    box-shadow: var(--shadow-md);
}
.action-btn:active {
    transform: translateY(0);
}
/* Specific buttons */
.delete-btn {
    background: linear-gradient(135deg, #fee2e2, #fecaca);
    color: #dc2626;
}
.send-btn {
    background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
    color: #4f46e5;
}
.view-btn {
    background: linear-gradient(135deg, var(--primary-100), var(--primary-200));
    color: var(--primary-700);
    border: 1px solid var(--primary-300);
}
/* Student Link */
.student-link {
    color: var(--primary-700);
    font-weight: 700;
    text-decoration: none;
    padding-bottom: 2px;
    border-bottom: 2px solid transparent;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 8px;
}
.student-link:hover {
    color: var(--primary-600);
    border-bottom: 2px solid var(--primary-400);
}
/* Responsive tweaks */
@media (max-width: 1024px) {
    .sidebar {
        width: 90px;
        padding: 25px 15px;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    .sidebar h2, .nav-link span { display: none; }
    .main-content {
        margin-left: 90px;
        padding: 25px;
    }
    .nav-link {
        justify-content: center;
        padding: 18px 12px;
    }
    .nav-link i {
        font-size: 22px;
        margin-right: 0;
    }
}
@media (max-width: 768px) {
    .sidebar {
        height: 75px;
        width: 100%;
        bottom: 0;
        top: auto;
        flex-direction: row;
        padding: 0;
        justify-content: space-around;
        align-items: center;
        border-top: 2px solid rgba(255,255,255,0.2);
        border-top-right-radius: 20px;
        border-top-left-radius: 20px;
        border-bottom-right-radius: 0;
    }
    .nav-link {
        margin-bottom: 0;
        flex-direction: column;
        gap: 6px;
        font-size: 11px;
        width: 25%;
        padding: 12px 5px;
        border-radius: 0;
        border-top: 3px solid transparent;
        border-left: none;
    }
    .nav-link.active {
        border-top: 3px solid var(--primary-400);
        border-left: none;
    }
    .nav-link i { font-size: 22px; }
    .sidebar h2 { display: none; }
    .main-content { margin-left: 0; padding: 20px; padding-bottom: 90px; }
    .stat-card { flex-direction: column; padding: 30px 25px; text-align: center; }
    .stat-card .stat-content { flex-direction: column; gap: 20px; }
    .stat-card .stat-number { font-size: 56px; }
    .stat-card .stat-icon { width: 80px; height: 80px; font-size: 32px; }
    .filter-controls { flex-direction: column; gap: 15px; }
    .filter-group { width: 100%; min-width: 100%; }
    .filter-actions { flex-direction: column; width: 100%; }
    .filter-btn { width: 100%; justify-content: center; }
    .filter-status { margin-left: 0; width: 100%; text-align: center; }
    .top-bar { flex-direction: column; }
    .add-btn { width: 100%; justify-content: center; }
    .dash-header { flex-direction: column; align-items: flex-start; gap: 15px; }
    table, thead, tbody, th, td, tr { display: block; }
    thead { display: none; }
    tr {
        margin-bottom: 25px;
        border: 1px solid var(--primary-200);
        border-radius: var(--radius-md);
        background: var(--card-bg);
        padding: 20px;
        box-shadow: var(--shadow-md);
    }
    td {
        border: none;
        padding: 12px 8px;
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    td:first-child {
        font-weight: bold;
        font-size: 18px;
        border-bottom: 1px solid var(--primary-100);
        margin-bottom: 10px;
        padding-bottom: 15px;
    }
    td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--primary-700);
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .action-group {
        justify-content: center;
        margin-top: 10px;
    }
    #status {
        left: 20px;
        right: 20px;
        text-align: center;
        top: 20px;
    }
}
</style>
</head>
<body>
<div id="status"></div>
<aside class="sidebar">
    <h2><i class="fas fa-graduation-cap"></i> SASO Dashboard</h2>
    <a href="#" class="nav-link active"><i class="fas fa-th-large"></i> <span>Dashboard</span></a>
    <a href="index.html" class="nav-link"><i class="fas fa-user-plus"></i> <span>Add Record</span></a>
    <a href="#" class="nav-link logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a>
</aside>
<main class="main-content">
    <div class="dash-header">
        <div>
            <h1>Student Records Dashboard</h1>
            <p style="color: var(--text-muted); margin-top: 8px;">Manage and monitor all student information in one place</p>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div style="font-size: 14px; color: var(--text-muted); background: var(--primary-50); padding: 10px 18px; border-radius: var(--radius-md); border: 1px solid var(--primary-200);">
                <i class="fas fa-clock" style="margin-right: 8px;"></i>
                <span id="currentTime"></span>
            </div>
        </div>
    </div>
    
    <!-- Single Student Stats Card -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-content">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-number" id="totalStudents">0</div>
                    <div class="stat-label">Total Students Offense</div>
                    <div class="stat-description">
                        All students currently Offense in the Student Affairs and Service Office system.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filter Bar - WALANG RESET FILTERS BUTTON -->
    <div class="filter-bar">
        <div class="filter-header">
            <i class="fas fa-filter"></i>
            <h3>Filter Records by Date</h3>
        </div>
        <div class="filter-controls">
            <div class="filter-group">
                <label><i class="fas fa-calendar-alt"></i> Select Month</label>
                <select id="monthFilter" class="filter-select">
                    <option value="all">All Months</option>
                    <option value="01">January</option>
                    <option value="02">February</option>
                    <option value="03">March</option>
                    <option value="04">April</option>
                    <option value="05">May</option>
                    <option value="06">June</option>
                    <option value="07">July</option>
                    <option value="08">August</option>
                    <option value="09">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
            <div class="filter-group">
                <label><i class="fas fa-calendar"></i> Select Year</label>
                <select id="yearFilter" class="filter-select">
                    <option value="all">All Years</option>
                </select>
            </div>
            <div class="filter-group">
                <label><i class="fas fa-sort"></i> Sort By</label>
                <select id="sortFilter" class="filter-select">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="name_asc">Name (A-Z)</option>
                    <option value="name_desc">Name (Z-A)</option>
                </select>
            </div>
        </div>
        <div class="filter-actions">
            <!-- APPLY FILTERS BUTTON ONLY - WALANG RESET FILTERS -->
            <button class="filter-btn apply" onclick="applyFilters()">
                <i class="fas fa-check-circle"></i> Apply Filters
            </button>
            <div class="filter-status">
                <i class="fas fa-info-circle"></i> Showing: <span id="filterCount">All</span> records
            </div>
        </div>
    </div>
    
    <div class="top-bar">
        <input id="searchInput" class="search-box" placeholder="ðŸ” Search by name, ID, email, or course..." />
        <button class="add-btn" onclick="window.location='index.html'">
            <i class="fas fa-user-plus"></i> Add New Student
        </button>
    </div>
    
    <div class="table-wrapper">
        <table id="recordTable">
            <thead>
                <tr>
                    <th>Student Information</th>
                    <th>ID & Course</th>
                    <th>Date Registered</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr class="loading-row"><td colspan="4" style="text-align:center; padding:40px;">
                    <div style="display:flex; flex-direction:column; align-items:center; gap:20px;">
                        <div style="width: 60px; height: 60px; border: 4px solid var(--primary-200); border-top-color: var(--primary-500); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span style="font-size:16px; color:var(--text-muted);">Loading student records...</span>
                    </div>
                </td></tr>
            </tbody>
        </table>
    </div>
</main>

<script type="module">
// Firebase initialization
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

const firebaseConfig = { 
  apiKey: "AIzaSyDFT7z-AmRLu8lig84D_tKA9OhF7joW9c0", 
  authDomain: "sasosystem-206d0.firebaseapp.com", 
  projectId: "sasosystem-206d0", 
  storageBucket: "sasosystem-206d0.appspot.com", 
  messagingSenderId: "526763192518", 
  appId: "1:526763192518:web:b1f544270439e8664067c7" 
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

onAuthStateChanged(auth, u => { 
    if(!u) location.href = "login.html"; 
});

window.logout = async () => { 
    if(confirm("Are you sure you want to logout?")) {
        await signOut(auth); 
        location.href = "login.html"; 
    }
};

// Global variables
let allRecords = [];
let filteredRecords = [];

// Update current time
function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', minute: '2-digit', hour12: true 
    });
    const dateString = now.toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });
    document.getElementById('currentTime').innerHTML = `<strong>${dateString}</strong> â€¢ ${timeString}`;
}
updateTime();
setInterval(updateTime, 60000);

// Populate year dropdown
function populateYearDropdown() {
    const yearSelect = document.getElementById('yearFilter');
    const currentYear = new Date().getFullYear();
    yearSelect.innerHTML = '<option value="all">All Years</option>';
    for (let year = 2020; year <= currentYear + 2; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
    }
}

// Helper functions
function getMonthName(monthNumber) {
    const months = [ 'January', 'February', 'March', 'April', 'May', 'June',
                     'July', 'August', 'September', 'October', 'November', 'December' ];
    return months[parseInt(monthNumber) - 1] || 'Unknown';
}

function extractMonthYear(recordData, recordId) {
    let dateValue = null;
    if (recordData.createdAt) {
        dateValue = recordData.createdAt;
    } else if (recordData.dateAdded) {
        dateValue = recordData.dateAdded;
    } else if (recordData.date) {
        dateValue = recordData.date;
    } else if (recordData.timestamp) {
        dateValue = recordData.timestamp;
    } else if (recordData.registrationDate) {
        dateValue = recordData.registrationDate;
    }
    
    if (!dateValue) {
        const now = new Date();
        return {
            month: String(now.getMonth() + 1).padStart(2, '0'),
            year: now.getFullYear(),
            dateObj: now
        };
    }
    
    try {
        let dateObj;
        if (typeof dateValue === 'number') {
            dateObj = new Date(dateValue);
        } else if (dateValue && typeof dateValue === 'object' && dateValue.toDate) {
            dateObj = dateValue.toDate();
        } else if (typeof dateValue === 'string') {
            dateObj = new Date(dateValue);
            if (isNaN(dateObj.getTime())) {
                const cleanDate = dateValue.split('T')[0];
                dateObj = new Date(cleanDate);
                if (isNaN(dateObj.getTime())) {
                    const now = new Date();
                    return {
                        month: String(now.getMonth() + 1).padStart(2, '0'),
                        year: now.getFullYear(),
                        dateObj: now
                    };
                }
            }
        } else {
            const now = new Date();
            return {
                month: String(now.getMonth() + 1).padStart(2, '0'),
                year: now.getFullYear(),
                dateObj: now
            };
        }
        
        if (isNaN(dateObj.getTime())) {
            const now = new Date();
            return {
                month: String(now.getMonth() + 1).padStart(2, '0'),
                year: now.getFullYear(),
                dateObj: now
            };
        }
        
        return {
            month: String(dateObj.getMonth() + 1).padStart(2, '0'),
            year: dateObj.getFullYear(),
            dateObj: dateObj
        };
    } catch (e) {
        const now = new Date();
        return {
            month: String(now.getMonth() + 1).padStart(2, '0'),
            year: now.getFullYear(),
            dateObj: now
        };
    }
}

// Apply filters function - GUMAGANA
function applyFilters() {
    const monthFilter = document.getElementById('monthFilter').value;
    const yearFilter = document.getElementById('yearFilter').value;
    const sortFilter = document.getElementById('sortFilter').value;
    
    let filtered = allRecords.filter(record => {
        const dateInfo = extractMonthYear(record.data, record.id);
        
        // Check month filter
        if (monthFilter !== 'all') {
            if (dateInfo.month !== monthFilter) {
                return false;
            }
        }
        
        // Check year filter
        if (yearFilter !== 'all') {
            if (dateInfo.year.toString() !== yearFilter) {
                return false;
            }
        }
        
        return true;
    });
    
    // Sort records
    filtered = sortRecords(filtered, sortFilter);
    filteredRecords = filtered;
    
    // Display results
    displayRecords();
    updateFilterStatus();
    showToast("Filters applied successfully.");
}

// Sort records
function sortRecords(records, sortOption) {
    return [...records].sort((a, b) => {
        const aData = a.data;
        const bData = b.data;
        switch(sortOption) {
            case 'newest':
                const aDate = extractMonthYear(aData, a.id).dateObj;
                const bDate = extractMonthYear(bData, b.id).dateObj;
                return bDate - aDate;
            case 'oldest':
                const aDateOld = extractMonthYear(aData, a.id).dateObj;
                const bDateOld = extractMonthYear(bData, b.id).dateObj;
                return aDateOld - bDateOld;
            case 'name_asc':
                return (aData.name || '').localeCompare(bData.name || '');
            case 'name_desc':
                return (bData.name || '').localeCompare(aData.name || '');
            default:
                return 0;
        }
    });
}

// Update filter status
function updateFilterStatus() {
    const filterCount = document.getElementById('filterCount');
    const totalRecords = allRecords.length;
    const filteredCount = filteredRecords.length;
    const monthFilter = document.getElementById('monthFilter').value;
    const yearFilter = document.getElementById('yearFilter').value;
    
    if (monthFilter === 'all' && yearFilter === 'all') {
        filterCount.textContent = `All (${totalRecords})`;
    } else {
        filterCount.textContent = `${filteredCount} of ${totalRecords}`;
        let filterText = '';
        if (monthFilter !== 'all') {
            filterText += getMonthName(monthFilter);
        }
        if (yearFilter !== 'all') {
            if (filterText) filterText += ' ';
            filterText += yearFilter;
        }
        if (filterText) {
            filterCount.textContent += ` (${filterText})`;
        }
    }
}

// Load records from Firebase
async function loadRecords() {
    const tbody = document.getElementById("tableBody");
    try {
        const snap = await getDocs(collection(db, "studentRecords"));
        tbody.innerHTML = "";
        allRecords = [];
        snap.forEach(d => {
            allRecords.push({ id: d.id, data: d.data() });
        });
        document.getElementById("totalStudents").textContent = allRecords.length;
        
        // Set filteredRecords to ALL records initially
        filteredRecords = [...allRecords];
        
        // Apply default sorting (newest first)
        filteredRecords = sortRecords(filteredRecords, 'newest');
        
        // Display all records initially
        displayRecords();
        updateFilterStatus();
        
        if (allRecords.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:50px;">
                <div style="display:flex; flex-direction:column; align-items:center; gap:20px;">
                    <i class="fas fa-user-slash" style="font-size:64px; color:var(--primary-300);"></i>
                    <div>
                        <h3 style="color:var(--text-muted); margin-bottom:10px;">No student records found</h3>
                        <p style="color:var(--text-light); max-width:400px; margin:0 auto 20px;">
                            Get started by adding your first student record to the system.
                        </p>
                        <button class="add-btn" onclick="window.location='index.html'" style="width:auto; margin-top:10px;">
                            <i class="fas fa-user-plus"></i> &nbsp; Add Your First Student
                        </button>
                    </div>
                </div></td></tr>`;
        }
    } catch (err) {
        console.error("Error loading records:", err);
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:40px; color:#dc2626;">
            <div style="display:flex; flex-direction:column; align-items:center; gap:15px;">
                <i class="fas fa-exclamation-triangle" style="font-size:48px;"></i>
                <div>
                    <h3 style="margin-bottom:10px;">Connection Error</h3>
                    <p style="color:var(--text-muted); max-width:400px; margin:0 auto 20px;">
                        Unable to load student records. Please check your internet connection.
                    </p>
                    <button onclick="loadRecords()" style="padding:12px 24px; background:var(--primary-500); color:white; border:none; border-radius:var(--radius-md); cursor:pointer; font-weight:600; display:inline-flex; align-items:center; gap:8px;">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                </div>
            </div></td></tr>`;
    }
}

// Display records in table
function displayRecords() {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    
    if (filteredRecords.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:50px;">
            <div style="display:flex; flex-direction:column; align-items:center; gap:20px;">
                <i class="fas fa-search" style="font-size:64px; color:var(--primary-300);"></i>
                <div>
                    <h3 style="color:var(--text-muted); margin-bottom:10px;">No records match your filters</h3>
                    <p style="color:var(--text-light); max-width:400px; margin:0 auto 20px;">
                        Try changing your month/year filters.
                    </p>
                </div>
            </div></td></tr>`;
        return;
    }
    
    let rowIndex = 0;
    filteredRecords.forEach(record => {
        const r = record.data;
        const row = tbody.insertRow();
        
        const dateInfo = extractMonthYear(r, record.id);
        const formattedDate = dateInfo.dateObj.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
        const monthYearDisplay = `${getMonthName(dateInfo.month)} ${dateInfo.year}`;
        
        row.innerHTML = `
            <td data-label="Student Information">
                <a href="student.html?id=${record.id}" class="student-link">
                    <i class="fas fa-user-graduate"></i>${r.name || "No Name"}
                </a>
                <br>
                <span style="color:var(--text-muted); font-size:13px; display:flex; align-items:center; gap:6px; margin-top:5px;">
                    <i class="fas fa-envelope"></i>${r.cca_email || "No email"}
                </span>
            </td>
            <td data-label="ID & Course">
                <span style="font-weight:600; color:var(--primary-700); display:flex; align-items:center; gap:6px;">
                    <i class="fas fa-id-card"></i>${r.student_number || "N/A"}
                </span>
                <br>
                <span style="font-size:14px; color:var(--text-muted); display:flex; align-items:center; gap:6px; margin-top:5px;">
                    <i class="fas fa-graduation-cap"></i>${r.course || "No course specified"}
                </span>
            </td>
            <td data-label="Date Registered">
                <div class="date-cell">
                    <i class="fas fa-calendar-day"></i>
                    <div>
                        <div style="font-weight:600;">${formattedDate}</div>
                        <div style="font-size:12px; color:var(--text-light);">${monthYearDisplay}</div>
                    </div>
                </div>
            </td>
            <td data-label="Actions">
                <div class="action-group">
                    <button class="action-btn view-btn" onclick="window.location='student.html?id=${record.id}'" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="action-btn send-btn" onclick="sendRecord('${record.id}')" title="Export to Word">
                        <i class="fas fa-file-word"></i>
                    </button>
                    <button class="action-btn delete-btn" onclick="deleteRecord('${record.id}')" title="Delete Record">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>`;
        rowIndex++;
    });
}

// Show toast notification
function showToast(msg, type = "success") {
    const toast = document.getElementById("status");
    toast.innerText = msg;
    if (type === "error") {
        toast.style.background = "linear-gradient(135deg, #dc2626, #b91c1c)";
    } else if (type === "warning") {
        toast.style.background = "linear-gradient(135deg, #f59e0b, #d97706)";
    } else {
        toast.style.background = "linear-gradient(135deg, var(--primary-500), var(--primary-700))";
    }
    toast.style.display = "block";
    setTimeout(() => toast.style.display = "none", 4000);
}

// Delete record function
window.deleteRecord = async (id) => {
    if(confirm("Are you sure you want to permanently delete this student record? This action cannot be undone.")) { 
        try {
            await deleteDoc(doc(db, "studentRecords", id));
            showToast("Student record deleted successfully.");
            loadRecords();
        } catch (err) {
            showToast("Error deleting record. Please try again.", "error");
        }
    }
};

// Export record function
window.sendRecord = (id) => {
    if(confirm("Export this student record to Word document?")) {
        showToast("Preparing document for download...");
        setTimeout(() => {
            const docId = "1xVaIORaF4Ll6sVHu8bmXUE0dK_E46gc5m5-1FM8T9o8";
            window.open(`https://docs.google.com/document/d/${docId}/export?format=docx`, "_blank");
            showToast("Document ready! Check your downloads.");
        }, 1000);
    }
};

// Search functionality
document.getElementById("searchInput").addEventListener("input", e => {
    const searchTerm = e.target.value.toLowerCase().trim();
    const rows = document.querySelectorAll("#tableBody tr");
    rows.forEach(r => {
        if (r.cells.length === 1) return;
        const rowText = r.innerText.toLowerCase();
        r.style.display = rowText.includes(searchTerm) ? "" : "none";
    });
});

// Initialize
populateYearDropdown();

// Set initial filter values
document.getElementById('monthFilter').value = 'all';
document.getElementById('yearFilter').value = 'all';
document.getElementById('sortFilter').value = 'newest';

// Add event listeners for filters (auto-apply when dropdowns change)
document.getElementById('monthFilter').addEventListener('change', applyFilters);
document.getElementById('yearFilter').addEventListener('change', applyFilters);
document.getElementById('sortFilter').addEventListener('change', applyFilters);

// Load records
loadRecords();

// Add CSS for spinner animation
const style = document.createElement('style');
style.textContent = `
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
`;
document.head.appendChild(style);
</script>
</body>
</html>